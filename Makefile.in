INCS=-I<WIRESHARK_SRC_ROOT> -I/usr/include/glib-2.0 -I/usr/lib/glib-2.0/include
SRCS = packet-fast.c dissect.c setup.c decode.c template.c debug.c

CC   = gcc

OBJS = $(foreach src, $(SRCS), $(src:.c=.o))

PLUGIN_NAME = packet-fast
PLUGIN_DIR = <WIRESHARK_OUT>
PLUGIN      = $(PLUGIN_DIR)/$(PLUGIN_NAME).so
TEST = test

CFLAGS = -DHAVE_CONFIG_H $(INCS) -DINET6 -D_U_=__attribute__\(\(unused\)\) -Wall -Wpointer-arith -g -DXTHREADS -D_REENTRANT -DXUSE_MTSAFE_API -fPIC -DPIC

$(PLUGIN) : $(OBJS)
	mkdir -p $(PLUGIN_DIR)
	$(CC) -shared $(OBJS) -o $@

%.o : %.c
	$(CC) -c $(CFLAGS) $< -o $@

# Run this rule on Makefile.in
fast-wireshark-%.tar.gz:
	find . -name .svn -prune -o -type f -not -name "$(@)" -print0 \
	| tar -cvzf "$(@)" --null -T - --transform="s:^\.:fast-wireshark-$(*):"


.PHONY: test
test: $(PLUGIN)
	make -C $(TEST) test

.PHONY: clean
clean:
	rm -f $(PLUGIN) $(OBJS) Makefile *.tar.gz
	make -C $(TEST) clean

