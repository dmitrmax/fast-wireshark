
include Makefile.common

INCS=-I<WIRESHARK_SRC_ROOT> -I/usr/include/glib-2.0 -I/usr/lib/glib-2.0/include

SRCS = $(DISSECTOR_SRC)

CC   = gcc
CPP  = cpp

OBJS = $(SRCS:.c=.o)

# Remove implicit suffix rules
#.SUFFIXES:
# At present we don't need to

PLUGIN_DIR = <WIRESHARK_OUT>
PLUGIN      = $(PLUGIN_DIR)/$(PLUGIN_NAME).so
TEST = test

# Make it so the included rules below do not become default.
.PHONY: all
all: $(PLUGIN)

# build dependencies
-include $(SRCS:.c=.d)

CFLAGS = -DHAVE_CONFIG_H $(INCS) -DINET6 \
	-D_U_=__attribute__\(\(unused\)\) -Wpointer-arith \
	-g -Wall -ansi -pedantic \
	-DXTHREADS -D_REENTRANT -DXUSE_MTSAFE_API -fPIC -DPIC

$(PLUGIN) : $(OBJS)
	mkdir -p $(PLUGIN_DIR)
	$(CC) -shared $(OBJS) -o $@

# Do this if we wanna be cool
#%.o: %.d
#%.d: %.c
#	$(CPP) -MM $(CFLAGS) $*.c \
#	| sed -e '1s:^:$(@) :' > $(@)

%.o: %.c
	$(CC) -c $(CFLAGS) $*.c -o $@
	$(CPP) -MM $(CFLAGS) $*.c -o $*.d

# Run this rule on Makefile.in
fast-wireshark-%.tar.gz:
	find . -name .svn -prune -o -type f -not -name "$(@)" -print0 \
	| tar -cvzf "$(@)" --null -T - --transform="s:^\.:fast-wireshark-$(*):"

fast-wireshark-%.zip: fast-wireshark-%.tar.gz
	tar xf fast-wireshark-$(*).tar.gz
	zip -r $(@) fast-wireshark-$(*)
	rm -r fast-wireshark-$(*) fast-wireshark-$(*).tar.gz

tags: *.c
	ctags *.c

.PHONY: test
test: $(PLUGIN)
	make -C $(TEST) test

.PHONY: clean
clean:
	rm -f $(OBJS) *.d tags
	make -C $(TEST) clean

.PHONY: distclean
distclean: clean
	rm -f $(PLUGIN) Makefile fast-wireshark-*


